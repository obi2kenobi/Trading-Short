//@version=6
// ──────────────────────────────────────────────────────────────────────────────
// @title        TEMA-ST-WT SHORT OPTIMIZED v2.1
// @description  Short reattivo in bear market con filtri adattivi
// @version      2.1
// ──────────────────────────────────────────────────────────────────────────────

// — INPUT TIMEFRAME —
tf = input.string("120", "Timeframe operativo", options = ["120","240","D"])
tf_filter = input.string("D", "Timeframe filtro bear market", options = ["D","W"], tooltip="Short SOLO se sotto TEMA 200 su questo TF")

// — DATI MULTITF —
[close_tf, high_tf, low_tf, hl2_tf, hlc3_tf, vol_tf] = request.security(syminfo.tickerid, tf, [close, high, low, hl2, hlc3, volume])
close_htf = request.security(syminfo.tickerid, tf_filter, close)

// — STRATEGY SETTINGS —
strategy("TEMA-ST-WT SHORT OPT v2.1", overlay=true,
     initial_capital    = 100000,
     default_qty_type   = strategy.percent_of_equity,
     default_qty_value  = 100,
     pyramiding         = 0,
     commission_type    = strategy.commission.percent,
     commission_value   = 0.01)

// ═══════════════════════════════════════════════════════════════════════════════
// FILTRO BEAR MARKET
// ═══════════════════════════════════════════════════════════════════════════════

tema200_htf = request.security(syminfo.tickerid, tf_filter, 3*ta.ema(close, 200) - 3*ta.ema(ta.ema(close, 200), 200) + ta.ema(ta.ema(ta.ema(close, 200), 200), 200))
isBearMarket = close_htf < tema200_htf

// ═══════════════════════════════════════════════════════════════════════════════
// PARAMETRI BASE
// ═══════════════════════════════════════════════════════════════════════════════

temaLen_in   = 32
stFactor_in  = 2.6
maxDistATR   = 1.4
temaLen_out  = 34
stFactor_out = 2.8
wtN2_in      = 21
stopPerc     = 2.5 / 100
tpPerc       = 8.0 / 100

stPeriod_in  = 10
wtN1_in      = 10
stPeriod_out = 10
wtN1_out     = 10
wtN2_out     = 21

// PARAMETRI ADATTIVI (si alleggeriscono in bear market)
var float volMultiplier = 1.3
var float slopeThreshold = 0.01

// Opzioni visualizzazione
showLabels   = input.bool(true, "Mostra labels trade")
showDashboard = input.bool(true, "Mostra dashboard")
showLevels   = input.bool(true, "Mostra livelli SL/TP")
showBearFilter = input.bool(true, "Mostra TEMA 200 HTF")

// ═══════════════════════════════════════════════════════════════════════════════
// INDICATORS
// ═══════════════════════════════════════════════════════════════════════════════

// TEMA IN / OUT
tema_in  = 3*ta.ema(close_tf, temaLen_in) - 3*ta.ema(ta.ema(close_tf, temaLen_in), temaLen_in) + ta.ema(ta.ema(ta.ema(close_tf, temaLen_in), temaLen_in), temaLen_in)
tema_out = 3*ta.ema(close_tf, temaLen_out) - 3*ta.ema(ta.ema(close_tf, temaLen_out), temaLen_out) + ta.ema(ta.ema(ta.ema(close_tf, temaLen_out), temaLen_out), temaLen_out)

// Supertrend IN
atr_in = ta.atr(stPeriod_in)
upC_in = hl2_tf - stFactor_in * atr_in
dnC_in = hl2_tf + stFactor_in * atr_in
var float _up_in = na
var float _dn_in = na
var int trend_in = 0
_up_in := close_tf[1] > nz(_up_in[1], upC_in) ? math.max(upC_in, nz(_up_in[1], upC_in)) : upC_in
_dn_in := close_tf[1] < nz(_dn_in[1], dnC_in) ? math.min(dnC_in, nz(_dn_in[1], dnC_in)) : dnC_in
trend_in := close_tf > _dn_in[1] ? 1 : close_tf < _up_in[1] ? -1 : nz(trend_in[1])

// Supertrend OUT
atr_out = ta.atr(stPeriod_out)
upC_out = hl2_tf - stFactor_out * atr_out
dnC_out = hl2_tf + stFactor_out * atr_out
var float _up_out = na
var float _dn_out = na
var int trend_out = 0
_up_out := close_tf[1] > nz(_up_out[1], upC_out) ? math.max(upC_out, nz(_up_out[1], upC_out)) : upC_out
_dn_out := close_tf[1] < nz(_dn_out[1], dnC_out) ? math.min(dnC_out, nz(_dn_out[1], dnC_out)) : dnC_out
trend_out := close_tf > _dn_out[1] ? 1 : close_tf < _up_out[1] ? -1 : nz(trend_out[1])

// WT IN
ap_in  = hlc3_tf
esa_in = ta.ema(ap_in, wtN1_in)
d_in   = ta.ema(math.abs(ap_in - esa_in), wtN1_in)
ci_in  = (ap_in - esa_in) / (0.015 * d_in)
wt1_in = ta.ema(ci_in, wtN2_in)
wt2_in = ta.sma(wt1_in, 4)
wtDown = wt1_in < wt2_in

// WT OUT
ap_out  = hlc3_tf
esa_out = ta.ema(ap_out, wtN1_out)
d_out   = ta.ema(math.abs(ap_out - esa_out), wtN1_out)
ci_out  = (ap_out - esa_out) / (0.015 * d_out)
wt1_out = ta.ema(ci_out, wtN2_out)
wt2_out = ta.sma(wt1_out, 4)
wtUp    = ta.crossover(wt1_out, wt2_out)

distATR = (tema_in - close_tf) / atr_in

// ═══════════════════════════════════════════════════════════════════════════════
// ENTRY FILTERS ADATTIVI
// ═══════════════════════════════════════════════════════════════════════════════

tema_slope = tema_in - tema_in[1]

// FILTRI ADATTIVI: più permissivi in bear market confermato
var bool tema_slope_negative = false
var float activeVolMultiplier = volMultiplier
var float activeSlopeThreshold = slopeThreshold

if isBearMarket
    // In bear market confermato: filtri alleggeriti
    tema_slope_negative := tema_slope < 0  // qualsiasi pendenza negativa
    activeVolMultiplier := 1.0  // volume normale accettato
    activeSlopeThreshold := 0.015  // maggiore tolleranza lateralità
else
    // Fuori bear market: filtri severi
    tema_slope_negative := tema_slope < -0.001
    activeVolMultiplier := volMultiplier
    activeSlopeThreshold := slopeThreshold

// Filtro lateralità
tema_slope_ratio = math.abs(tema_slope) / ta.atr(10)
isFlatSlope = tema_slope_ratio < activeSlopeThreshold

rangeHigh5 = ta.highest(high_tf, 5)
rangeLow5  = ta.lowest(low_tf, 5)
rangeCond  = (rangeHigh5 - rangeLow5) / close_tf < 0.01
isLateral  = isFlatSlope or rangeCond

// Filtro volume
volMA = ta.sma(vol_tf, 20)
highVolume = vol_tf > volMA * activeVolMultiplier

// CONDIZIONE SHORT FINALE
shortOK = (trend_in == -1) and wtDown and tema_slope_negative and (distATR <= maxDistATR) and not isLateral and highVolume and isBearMarket
inShort = strategy.position_size < 0

if not inShort and shortOK
    strategy.entry("Short", strategy.short)

// ═══════════════════════════════════════════════════════════════════════════════
// POSITION MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════════

var float entryPrice = na
var int entryBar = na

if inShort and not inShort[1]
    entryPrice := strategy.position_avg_price
    entryBar := bar_index

stopPrice  = entryPrice * (1 + stopPerc)
limitPrice = entryPrice * (1 - tpPerc)

exit_wt    = wtUp
exit_st    = trend_out == 1
exit_tema  = close_tf > tema_out
exit_count = (exit_wt ? 1 : 0) + (exit_st ? 1 : 0) + (exit_tema ? 1 : 0)
shouldExit = exit_count >= 2
exit_bar   = inShort and shouldExit

if inShort
    strategy.exit("SL/TP", from_entry="Short", stop=stopPrice, limit=tpPerc > 0 ? limitPrice : na)
    if exit_bar
        strategy.close("Short", comment="Cover")

// ═══════════════════════════════════════════════════════════════════════════════
// PLOTS
// ═══════════════════════════════════════════════════════════════════════════════

// TEMA 200 HTF (Bear market filter)
plot(showBearFilter ? tema200_htf : na, "TEMA 200 HTF", color=isBearMarket ? color.new(color.red, 40) : color.new(color.green, 40), linewidth=3, style=plot.style_line)

// TEMA lines
plot(tema_in, "TEMA IN", color=color.new(color.purple, 0), linewidth=2)
plot(tema_out, "TEMA OUT", color=color.new(color.blue, 50), linewidth=1, style=plot.style_circles)

// Supertrend
plot(trend_in==-1 ? _dn_in : na, "ST Dn (Short)", color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr)
plot(trend_in==1 ? _up_in : na, "ST Up (Exit)", color=color.new(color.green, 0), linewidth=2, style=plot.style_linebr)

// Background
bgcolor(isBearMarket ? color.new(color.red, 97) : color.new(color.green, 97), title="Bear/Bull Market")
bgcolor(inShort ? color.new(color.red, 92) : na, title="In Position")

// SL/TP levels
plot(showLevels and inShort ? stopPrice : na, "Stop Loss", color=color.new(color.red, 0), linewidth=2, style=plot.style_cross)
plot(showLevels and inShort ? limitPrice : na, "Take Profit", color=color.new(color.green, 0), linewidth=2, style=plot.style_cross)
plot(showLevels and inShort ? entryPrice : na, "Entry", color=color.new(color.white, 0), linewidth=1, style=plot.style_circles)

// Entry signal
plotshape(shortOK and not inShort, "SHORT", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.large)

// Exit signal
plotshape(exit_bar, "COVER", shape.triangleup, location.belowbar, color.new(color.lime, 0), size=size.large)

// ═══════════════════════════════════════════════════════════════════════════════
// LABELS
// ═══════════════════════════════════════════════════════════════════════════════

if showLabels
    // Entry label
    if shortOK and not inShort
        filterMode = isBearMarket ? "BEAR MODE" : "NORMAL"
        label.new(bar_index, high_tf, 
             text="SHORT " + filterMode + "\n" + str.tostring(close_tf, "#.##") + "\nSL: " + str.tostring(stopPrice, "#.##") + "\nTP: " + str.tostring(limitPrice, "#.##"), 
             style=label.style_label_down, 
             color=color.red, 
             textcolor=color.white, 
             size=size.normal)
    
    // Exit label
    if exit_bar
        profitPct = ((entryPrice - close_tf) / entryPrice) * 100
        profitColor = profitPct > 0 ? color.green : color.red
        label.new(bar_index, low_tf, 
             text="COVER\n" + str.tostring(close_tf, "#.##") + "\nP&L: " + str.tostring(profitPct, "#.##") + "%", 
             style=label.style_label_up, 
             color=profitColor, 
             textcolor=color.white, 
             size=size.normal)

// ═══════════════════════════════════════════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════════════════════════════════════════

if showDashboard
